---
name: third_party_check
on:
  pull_request:
    paths:
      - '**/go.mod'

permissions:
  contents: read

env:
  GOTOOLCHAIN: local

jobs:
  changed_gomods:
    runs-on: ubuntu-latest
    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
      with:
        egress-policy: audit

    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      with:
        fetch-depth: 2
    - uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
      with:
        go-version: 1.25.x
    - name: Find modified go.mod files
      id: modfiles
      run: |
        dirs=$(cd internal/actions; go run ./cmd/changefinder -q -internal --base=HEAD~1 --diff-filter=d --path-filter='*go.mod' --dir=${{ github.workspace }})
        if [ -z "$dirs" ]
        then
          echo "skip=1" >> "$GITHUB_OUTPUT"
          echo "No new/modified go.mod files!"
        else
          for d in $dirs; do list=${list},\"${d}\"; done
          echo "mods={\"mods\":[${list#,}]}" >> "$GITHUB_OUTPUT"
          echo "skip=" >> "$GITHUB_OUTPUT"
        fi
    outputs:
      mods: ${{ steps.modfiles.outputs.mods }}
      skip: ${{ steps.modfiles.outputs.skip }}
  check_deps:
    needs: changed_gomods
    runs-on: ubuntu-latest
    if: "!needs.changed_gomods.outputs.skip"
    continue-on-error: true
    strategy:
      matrix: ${{ fromJson(needs.changed_gomods.outputs.mods) }}
    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
      with:
        egress-policy: audit

    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
    - run: |
        cd internal/actions
        go run ./internal/actions/cmd/thirdpartycheck -q --dir=${{ github.workspace }} -mod ${{ matrix.mods }}/go.mod
