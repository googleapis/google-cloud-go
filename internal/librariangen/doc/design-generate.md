# Go Librarian Onboarding \- Generate

| \#begin-approvals-addon-section Username Role Status Last change [bisun](http://teams/bisun) Approver 🟢 Approved Jul 18, 2025 [codyoss](http://teams/codyoss) Approver 🟢 Approved Jul 17, 2025 [jonskeet](http://teams/jonskeet) Approver 🟢 Approved Jul 21, 2025 [ldetmer](http://teams/ldetmer) Approver 🟢 Approved Jul 17, 2025 [joewa](http://teams/joewa) Reviewer 🟢 LGTM Jul 17, 2025 [omairn](http://teams/omairn) Reviewer 🟢 LGTM Jul 17, 2025 [partheniou](http://teams/partheniou) Reviewer 🟢 LGTM Jul 21, 2025      ![][image1] Approval Instructions: Please approve, or LGTM through the [G3 Assist](https://goto.google.com/g3a-approvals-reviewing) sidebar. For more information, see [go/g3a-approvals-reviewing](https://goto.google.com/g3a-approvals-reviewing)  |
| ----- |

**Author(s):** [Chris Smith](mailto:chrisdsmith@google.com)| **Last Updated**: Jul 21, 2025  | **Status**: Review   
**Self link:** [go/librarian:go-librarian-generate](http://goto.google.com/librarian:go-librarian-generate) | **Project Issue**: [b/425766855](http://b/425766855), [b/430109429](http://b/430109429)

# Objective

Onboard Go GAPIC client library generation to the Librarian 0.2 platform, replacing the legacy `bazel-bot`, `OwlBot` and `googleapis-gen` toolchain with a modern, container-based solution.

The primary goal is to achieve a **backward-compatible migration**. The assets generated by the new system must be identical to those produced by the existing pipeline, including generated source code and the externally-located snippets files. This ensures a seamless transition with no impact on users or downstream release tooling.

The initial scope of this effort is to regenerate a single, existing client library (in [google-cloud-go](https://github.com/googleapis/google-cloud-go), this is a top-level submodule such as `google-cloud-go/workflows`) to validate the process before proceeding with a full-scale migration.

# Background

The current code generation process is a complex, multi-stage pipeline distributed across several tools and repositories:

1. **Generation:** `bazel-bot` invokes `protoc` via Bazel to generate Go source code from the public API definitions in `googleapis` into a private intermediate repository, `googleapis-gen`.  
2. **File placement:** `OwlBot` opens a PR to copy the generated code from `googleapis-gen` into the final `google-cloud-go` repository, applying rules for file inclusion and preservation defined in a central `.OwlBot.yaml` file.  
3. **Post-processing:** In the PR, a Go-specific `OwlBot` post-processor runs to perform cleanup, apply code modifications, and generate additional files (like `go.mod`, `README.md` and `version.go`) that are not handled by the core `protoc` generators.

This architecture is vulnerable to security and maintenance concerns, as documented in the [1PP Engineering Plan](https://docs.google.com/document/d/1_iLARXR7ZEJALSyXUjdFWhFbSJq9GCDhu1BUUIPKLkI/edit). The Librarian project was created to replace this legacy toolchain with a standardized, secure, and maintainable system.

# Overview

This document outlines a phased migration to a containerized Go generator that conforms to the [librarian CLI: generate command](http://go/librarian:generate-command) contract. The core strategy is to adapt existing tools and inputs to the new workflow, deferring major architectural changes (like replacing Bazel configuration files) to accelerate delivery and reduce risk.

The new workflow will be orchestrated by the central Librarian tool and will consist of three main steps, each corresponding to a command passed to the Go `librariangen` Docker container:

1. **`configure` (onboarding):** For a new library, Librarian invokes `librariangen` to enrich a minimal request with Go-specific conventions (e.g., deriving Go module paths) and preserved file paths. The container returns configure-response.json, which Librarian will store in the repository's central `state.yaml`. See [librarian CLI: generate command](http://go/librarian:generate-command) for more details.  
2. **`generate` (code generation):** Librarian invokes `librariangen` to perform the core code generation. The container receives API definitions, invokes `protoc`, runs a custom Go post-processor, and writes the final code to an `/output` directory.  
3. **`build` (validation):** After Librarian has copied the generated code into a full checkout of the `google-cloud-go` repository, it invokes `librariangen` to run `go build` and `go test`, validating that the new code integrates correctly.

This document focuses on the delivery of a production-ready solution for the `generate` step. The high-level workflow for the `generate` step is as follows:

1. **Invocation:** The Librarian tool invokes the Go `librariangen` container with the `generate` command.  
2. **Inputs:** Librarian provides all necessary inputs as mounted directories:  
   * `/input`: A directory for optional, user-provided configuration, templates or scripts. Contains the contents of the `.librarian/generator-input` folder from the google-cloud-go repository (no input from this folder has yet been specified).  
   * `/librarian`: A configuration directory containing a `generate-request.json` file that specifies which APIs to generate for the target library.  
   * `/output`: An empty directory where the container must write all generated code. The directory structure should match the desired structure in the final repository.  
   * `/source`: A complete checkout of the `googleapis` repository.  
3. **Execution:** Inside the container, the `librariangen` binary runs the `gapicgen` component:  
   * `gapicgen` parses the `generate-request.json` to determine the target library and target APIs.  
   * `gapicgen` invokes `protoc` with the Go plugins (`protoc-gen-go`, protoc-gen-go-grpc, `protoc-gen-go_gapic`), passing `/source` as the import path (`-I`).  
   * `gapicgen` writes all generated `.go` files directly to the `/output` directory.  
4. **Post-processing:** After generation, the `librariangen` binary runs the `postprocessor` component:  
   * `postprocessor` generates files such as `version.go`, invokes `go mod tidy`, formats the code and runs linters.  
5. **Output:** The Librarian tool takes the contents of the `/output` directory and copies them to the correct location in the target `google-cloud-go` repository, based on the `source_paths` and `preserve_regex` rules in `state.yaml`.

This approach encapsulates the entire generation process within a single, well-defined container, eliminating dependencies on the legacy `bazel-bot` and `OwlBot` infrastructure.

# Detailed Design

## Repository configuration

All language repos will have a single `state.yaml` file located in their language repo at the location `<repo>/.librarian/state.yaml`. This file lets Librarian know which libraries it is responsible for generating.

```textproto
# The name of the image and tag to use for generation.
image: "gcr.io/cloud-go-infra/librarian-go:latest"

# The state of each library which is released within this repository.
libraries:
  - # The library identifier, which for Go contains the top-level submodule name "workflows".
    id: "google-cloud-workflows"
    # The last version that was released, if any.
    version: "1.14.2"
    # The commit hash from the googleapis/googleapis repository at which
    # the library was last generated.
    last_generated_commit: "a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6"
    # APIs that are bundled as a part of this library.
    apis:
      - path: "google/cloud/workflows/v1"
        service_config: "workflows_v1.yaml"
      - path: "google/cloud/workflows/v1beta"
        service_config: "workflows_v1beta.yaml"
      - path: "google/cloud/workflows/executions/v1"
        service_config: "workflowexecutions_v1.yaml"
      - path: "google/cloud/workflows/executions/v1beta"
        service_config: "workflowexecutions_v1beta.yaml"
    # Directories to which librarian contributes code. For Go, this is
    # typically the Go module directory.
    source_paths:
      - "workflows"
      - "internal/generated/snippets/workflows"
    # Files/directories to leave untouched during generation.
    # This is useful for preserving handwritten helper files or customizations.
    preserve_regex:
      - "workflows/aliasshim/aliasshim.go"
      - "workflows/CHANGES.md"
      - "workflows/internal/version.go"
```

## **Container (`librariangen/Dockerfile`)**

The implementation consists of a Go application packaged into a Docker container. The use of `ENTRYPOINT` configures the container to act as an executable, allowing the Librarian tool to pass commands like `generate` and `configure` as arguments directly to it. The application's binary then dispatches to different logic based on the command-line argument provided by Librarian.

The `librariangen` Docker container must use a MOSS-compliant [Google-approved base image](https://cloud.google.com/software-supply-chain-security/docs/base-images#google-provided_base_images). The preferred base image for Go is currently [`marketplace.gcr.io/google/debian12:latest`](http://marketplace.gcr.io/google/debian12:latest). (Debian is used for the official Go images at [https://hub.docker.com/\_/golang](https://hub.docker.com/_/golang), however these are not MOSS-compliant and Google-approved.)

The Dockerfile is responsible for:

* Installing specific, pinned versions of Go (`1.23.0`), `protoc` (`25.7`), and other required tools. The versions must be copied from current existing configuration for `bazel-bot/OwlBot` and `google-cloud-go`, such as the `_protobuf_version` setting in the `googleapis` [WORKSPACE](https://github.com/googleapis/googleapis/blob/master/WORKSPACE#L166) file.  
* Installing the latest compatible versions of the necessary Go protoc plugins: `google.golang.org/protobuf/cmd/protoc-gen-go` and `github.com/googleapis/gapic-generator-go/cmd/protoc-gen-go_gapic`.  
* Copying `librariangen`'s Go source code into the image and building it into a single executable binary (`/librariangen`).  
* Setting the `ENTRYPOINT` to the `/librariangen` binary.

The container should be hosted in `us-central1-docker.pkg.dev/client-library-releases/release-images-prod`, per the [AR Exit Gate Onboarding Guide](http://go/cloud-sdk-ar-exit-gate-onboarding).

## **Librarian Go generator binary (`librariangen/main.go`)**

The Go application serves as the container's entrypoint. It is a simple command-line application that dispatches logic based on the first argument passed to the container.

The binary’s command-line requirements  include:

* Accept a positional string argument containing one of the following commands:  
  * `configure`  
  * `generate`  
  * `build`  
* Accept filepath (absolute or relative) flags for **all** of the following mounted directories in the container, in order to provide a convenient development experience on a regular Google laptop (S-11 in [go/librarian-generation-lifecycle-requirements](http://goto.google.com/librarian-generation-lifecycle-requirements)).  
  * `/input`  
  * `/librarian`  
  * `/output`  
  * `/source`  
* Return exit code 0 if successful, or a non-zero error code if there was an error.

### **`generate` command**

This is the core command, responsible for the main generation logic. Its primary input is `/librarian/generate-request.json`, a JSON file describing the library and APIs to generate.

The `librariangen` container receives an empty `/output` directory, which is expected to be populated with the generated files. This `/output` directory represents the root of the destination repository (i.e., `google-cloud-go`).

For example, to generate files for the `workflows` top-level submodule (a Librarian "library"), the generator should write them to `/output/workflows`. To update snippet files, it would write to the corresponding path, such as `/output/internal/generated/snippets/workflows`.

Librarian copies files from the `/output` directory into the repository. The `source_paths` and `preserve_regex` paths configured for the library in `state.yaml` are used to figure out what to clean before copying, but not what to copy from `/output`. Everything in `/output` will be copied to the corresponding location in the repository.

To preserve files that are not generated, such as the manually created `workflows/aliasshim/aliasshim.go`, `preserve_regex` in `generate-request.json` must be configured. For example, to preserve the `aliasshim` directory, a `preserve_regex` entry of `aliasshim/aliasshim.go` would be used.

#### **Execution:**

1. **Parse Request:** The `gapicgen` component reads `generate-request.json`. The request can range from a simple, single-API client to a complex one with multiple versions and nested API paths.  
2. **Load Configuration:** For each API, `gapicgen` parses the corresponding `BUILD.bazel` file located in the `/source` directory (e.g., `/source/google/cloud/workflows/v1/BUILD.bazel`). This file is the source of truth for `protoc` options such as the transport layer (`grpc+rest`), service YAML path, and release level. This temporarily avoids having to duplicate this configuration. However, its allowed use is an interim measure until the service config (workflows\_v1.yaml) contains all the relevant information.  
3. **Execute `protoc`:** `gapicgen` constructs and executes the `protoc` command. See [gapicgen](#bookmark=id.uraq8t6fgyi7) below for more details.  
4. **Post-process:** The `postprocessor` component manipulates the contents of `/output` to produce a release-ready library. This step must ensure backward compatibility. This includes formatting, linting, generating `version.go`, and updating files. See [postprocessor](#bookmark=id.ad0pyly7zs49) below for more details.  
5. The Docker container returns exit code 0 if successful, or a non-zero error code if there was an error. If possible, it should also write a response that includes an error message. (This is TBD in Librarian.)

The final result is the complete, formatted, and backward-compatible Go client library, matching the structure of the existing library.

#### **gapicgen**

`gapicgen` is a standard Go application, making it easier for any Go developer to contribute, as opposed to the specialized Bazel knowledge required by the `bazel-bot` system. A significant difference compared to `bazel-bot` is that `gapicgen` must not access the internet.

Let's look at the details for our `workflows` example. The paths in `generate-request.json` may include nested APIs as in the real-world configuration for `workflows`:

##### 

```json
{
  "id": "google-cloud-workflows",
  "apis": [
    {
      "path": "google/cloud/workflows/v1",
      "service_config": "workflows_v1.yaml"
    },
    {
      "path": "google/cloud/workflows/v1beta",
      "service_config": "workflows_v1beta.yaml"
    },
    {
      "path": "google/cloud/workflows/executions/v1",
      "service_config": "workflowexecutions_v1.yaml"
    },
    {
      "path": "google/cloud/workflows/executions/v1beta",
      "service_config": "workflowexecutions_v1beta.yaml"
    }
  ],
  "source_roots": [
    "workflows",
    "internal/generated/snippets/workflows"
  ],
  "preserve_regex": [
    "workflows/aliasshim/aliasshim.go",
    "workflows/CHANGES.md",
    "workflows/internal/version.go"
  ],
  "remove_regex": [
    "workflows",
    "internal/generated/snippets/workflows"
  ]
}
```

For each path, `gapicgen` must load the Bazel rules configuration from the corresponding `BUILD.bazel` file in `googleapis`. Here is the configuration for `workflows/executions/v1`:

```protobuf
go_proto_library(
    name = "executions_go_proto",
    compilers = ["@io_bazel_rules_go//proto:go_grpc"],
    importpath = "cloud.google.com/go/workflows/executions/apiv1/executionspb",
    protos = [":executions_proto"],
    deps = [
        "//google/api:annotations_go_proto",
    ],
)

go_gapic_library(
    name = "executions_go_gapic",
    srcs = [":executions_proto_with_info"],
    grpc_service_config = "executions_grpc_service_config.json",
    importpath = "cloud.google.com/go/workflows/executions/apiv1;executions",
    metadata = True,
    release_level = "ga",
    rest_numeric_enums = False,
    service_yaml = "workflowexecutions_v1.yaml",
    transport = "grpc",
    deps = [
        ":executions_go_proto",
        "@io_bazel_rules_go//proto/wkt:duration_go_proto",
    ],
)
```

**Important:** The Bazel configurations are currently being transitioned from `go_proto_library` to `go_grpc_library`. For the purposes of obtaining the `importpath` value, these rules are equivalent. However, `gapicgen` must search for both rules. Only one should be present.

See the complete set of protos and related BUILD.bazel configuration for the Workflows API at [googleapis/google/cloud/workflows](https://github.com/googleapis/googleapis/tree/master/google/cloud/workflows/).

The key arguments to `protoc` are:

* `--go_out=/output` and `--go-gapic_out=/output`: Directs all generated files to the output directory.  
* `-I=/source`: Sets the `googleapis` checkout as an import path. Common dependencies such as `google.protobuf.Any` must also be configured with `-I`. See the \[rules\_go\_gapic\](https://github.com/googleapis/gapic-generator-[go/tree/main/rules\_go\_gapic](https://goto.google.com/tree)) source code for these dependencies and other important implementation details.  
* `--go-gapic_opt=...`: Passes the options extracted from the `BUILD.bazel` file to the [Go GAPIC Generator](https://github.com/googleapis/gapic-generator-go)).

Example of complete `protoc` command for `workflows/executions`:

```shell
protoc \
  --experimental_allow_proto3_optional \
  --go_out=/output \
  --go-gapic_out=/output \
  --go-gapic_opt="go-gapic-package=cloud.google.com/go/workflows/executions/apiv1;executions" \
  --go-gapic_opt="api-service-config=/source/google/cloud/workflows/executions/v1/workflowexecutions_v1.yaml" \
  --go-gapic_opt="grpc-service-config=/source/google/cloud/workflows/executions/v1/executions_grpc_service_config.json" \
  --go-gapic_opt="transport=grpc" \
  --go-gapic_opt="release-level=ga" \
  --go-gapic_opt="metadata" \
  --go-gapic_opt="rest-numeric-enums=false" \
  -I=/source \
  /source/google/cloud/workflows/executions/v1/executions.proto
```

#### postprocessor

A critical design decision is to forgo the existing, complex [post-processor](https://github.com/googleapis/google-cloud-go/tree/main/internal/postprocessor) in favor of a new, lightweight implementation directly within the `librariangen` binary. The current post-processor is unsuitable as it depends on a full `google-cloud-go` repository checkout and makes calls to the GitHub API. A significant difference compared to the current post-processor is that this `postprocessor` must not access the internet. (Temporary exceptions may be made initially but must eventually be removed.)

The new, self-contained post-processor runs entirely within the `/output` directory and performs the following essential tasks:

1. **`goimports`:** Runs `goimports -w .` to format the generated code and fix imports.  
2. **Module initialization:** Runs `go mod init` and `go mod tidy` to create a valid `go.mod` file for the newly generated code. This is a prerequisite for running other Go tools.  
3. **`version.go` Generation:** A `version.go` file is generated for each new Go module, containing the library version provided in the request.  
4. **Linting:** Runs `staticcheck ./...` to catch [potential issues](https://staticcheck.dev/) in the generated code.

As shown in the fragment directory structure below, snippet files must be written outside of the Go module's source tree (the `google-cloud-go/workflows` directory).

```shell
googleapis-gen/google/cloud/workflows/v1/cloud.google.com/go$ tree .
.
├── internal
│   └── generated
│       └── snippets
│           └── workflows
│               └── apiv1
│                   ├── Client
│                   │   ├── CreateWorkflow
│                   │   │   └── main.go
└── workflows
    └── apiv1
        ├── workflows_client.go
        └── workflowspb
            └── workflows.pb.go
```

In fact, there are a number of locations in the `google-cloud-go` monorepo that reference client library Go modules and must potentially be updated.

The shared files are:

* `.github/.OwlBot.yaml` (manual edit)  
* `internal/generated/snippets/<module>/<version>/**/*`  
* `internal/generated/snippets/go.mod`  
* `internal/postprocessor/config.yaml` (manual edit)  
* `internal/.repo-metadata-full.json`  
* `.release-please-manifest-submodules.json`  
* `go.work`  
* `release-please-config-yoshi-submodules.json`

Global files NOT modified by the current post-processor:

* `.github/.OwlBot.yaml`: This is a manual edit. The post-processor does not modify it.  
* `internal/postprocessor/config.yaml`: This is a manual edit. The post-processor does not modify it.

Library-scope (not global) files modified by the current post-processor:

* `internal/generated/snippets/<module>/<version>/**/*`: `UpdateSnippetsMetadata` in `main.go` updates a $VERSION placeholder within the `snippet_metadata.google.cloud.*.json` files within the `<module>/<version>` directories.

Global files modified by the current post-processor:

* `internal/.repo-metadata-full.json`: `Manifest` in `manifest.go` creates or truncates the file and then writes all Go modules' metadata to it.  
* `internal/generated/snippets/go.mod`: `modEditReplaceInSnippets` in `main.go` runs a command to update this file when new Go modules are added.  
* `.release-please-manifest-submodules.json`: `UpdateReleaseFiles` in `releaseplease.go` adds new Go modules to this manifest with a starting version of `0.0.0`.  
* `go.work`: `generateModule` in `main.go` calls a command to add new Go modules to the `go.work` file.  
* `release-please-config-yoshi-submodules.json`: `UpdateReleaseFiles` in `releaseplease.go` regenerates this file to include all Go modules.

A limitation of the current Librarian model is its inability to safely handle concurrent updates to global, repository-level files (e.g., `go.work`, `.release-please-manifest-submodules.json`). The generation process is isolated and not given the full repository context, in order to avoid merge conflicts if multiple generation processes attempt to modify the same global file. While the post-processor has the technical ability to write to any location in the `/output` directory, its isolation prevents it from reading files from the repository. See “Open Questions \- Global files” in [go/librarian:generate-command](http://goto.google.com/librarian:generate-command) for more information.

See [Risks](#bookmark=id.rws31fmldvpb) \- Updating global files below for more details.

# Testing Plan

A multi-faceted testing strategy is required to ensure a safe and successful migration.

1. **Manual integration testing:**

   * **Phase 1 (Validation):** Manually run the `librarian` CLI to regenerate \~10 existing libraries. Verify that the process completes successfully and produces **no diff** against the current code.  
   * **Phase 2 (Onboarding):** Use a script to run the `librarian` CLI to onboard the remaining \~180 libraries, verifying that the generated code also produces no diff.  
2. **Smoke testing:** A shell script will be used to perform basic validation of the Docker image itself, ensuring that all required tools (`protoc`, `go`, etc.) and dependencies are installed correctly. This can be run manually or as part of an automated CI check.

3. **Docker-based integration testing:** An automated script (`run-container-tests.sh`) will execute the full, containerized workflow for a suite of test libraries, covering important edge cases, including error cases. A test is successful if:

   * The `generate` command completes successfully.  
   * The subsequent `build` command, running against the newly generated code, passes all its tests (`go build` and `go test`).  
   * The output produces **no diff** against the current code.  
4. **Unit testing:** All new Go code written for the generator and post-processor will be accompanied by a comprehensive suite of unit tests.

# Alternatives considered

1. **Adapt Bazel-based generation:** An acceptable alternative is to continue using the existing Bazel-based system. This was rejected due to the team’s long dislike of Bazel’s high maintenance cost and complexity. If the preferred approach of directly using `protoc` takes longer than expected, we will fall back to using Bazel.

2. **Adapt the old post-processor:** An attempt was made to run the existing `postprocessor` tool inside the container. This was deemed infeasible. The tool is not designed to be portable; it requires a full `google-cloud-go` repository context (including a `.git` directory and `go.work` file) and contains logic for interacting with GitHub pull requests, none of which are available or relevant inside the generator container. The chosen approach of a new, focused post-processor is far simpler and more robust.

# Work Estimates

Please refer to [Librarian project \- CLI \+ Python \+ Go](https://github.com/orgs/googleapis/projects/27/views/16) on GitHub for specific deliverables and delivery dates.

# Documentation plan

**`librariangen/README.md`:** This will be the setup and usage document for `librariangen` and its Docker container, detailing its commands and how to run it both locally and using Docker. It will also cover typical development tasks such as running tests and re-publishing the Docker container after changes.

All documentation will be updated and made available before the first library is fully migrated to the new system.

# Launch plans

The migration to Librarian should be a gradual process. Starting at the end of July, 2025, it should consist of an incremental rollout with canaries spanning August, 2025\. Here are the stages:

1. Onboard a single Librarian library.  
   * Let Librarian run librariangen’s configure step for the library (or if necessary hand-code Librarian's initial `state.yaml`).  
   * Test that the generated code is identical to the code produced by the old system.  
   * Verify that Librarian correctly opens a PR to merge the changes.  
   * If ready, configure Librarian releases for the library.  
   * Verify that Librarian correctly releases the library.  
   * Remove the library from the OwlBot and release-please configurations.  
2. Repeat the steps above for the 90% of similarly straightforward libraries in google-cloud-go.  
3. Repeat the steps above for the eight "difficult" libraries below. This group is defined in gapic-generator-go's [test.sh](https://github.com/googleapis/gapic-generator-go/blob/main/test.sh).  
   * `datastore`  
   * `kms`  
   * `datacatalog`  
   * `texttospeech`  
   * `storage`  
   * `retail`  
   * `apigeeconnect`  
   * `bigquery`  
4. Repeat the steps above for all remaining libraries in google-cloud-go.  
5. Remove all OwlBot and release-please configuration.

## Timeline

Please refer to [Librarian project \- CLI \+ Python \+ Go](https://github.com/orgs/googleapis/projects/27/views/16) on GitHub for specific deliverables and delivery dates.

# Risks

## Difficulty replacing Bazel for all APIs

The logic for parsing `BUILD.bazel` files in `googleapis` might not account for all possible configurations or edge cases.

### Mitigation

Fall back to using Bazel instead of direct protoc within `librariangen`.

## Hidden OwlBot logic

The `.OwlBot.yaml` and underlying Bazel rules may contain subtle, undocumented logic. Migrating this correctly is critical for backward compatibility.

### Mitigation

During the full migration, identify and categorize all implicit logic. Allocate specific time for handling these cases.

## Updating global files

The migration must correctly handle updates to files that are shared across multiple Go modules (e.g., `internal/.repo-metadata-full.json`).

### Mitigation

The post-processor must be explicitly designed to handle global files, potentially by having a separate processing step that runs after all individual libraries are generated.

## Post-processing discrepancies

The new, streamlined post-processor might not perform all the subtle modifications that the old system did, potentially leading to minor differences in generated code.

### Mitigation

After processing changes for a library, perform a `diff` over the entire google-cloud-go repo. Compare against a whole-repo diff after an OwlBot change.

## Tool versioning

The generator's `Dockerfile` pins versions for `protoc` and its Go plugins. These dependencies can become stale.

### Mitigation

Implement automated dependency scanning (e.g., `RenovateBot`) for the `Dockerfile` to create pull requests whenever new tool versions are released.

# Open questions

## Do we need a PR presubmit running the Docker image?

New GCP project required. Might have needed alanga’s approval. See [go/sdk-librarian-python](http://goto.google.com/sdk-librarian-python) “Smoke testing” for details. Ask [Omair Naveed](mailto:omairn@google.com) for more info.

### Notes on the Python presubmit

A change to the contents of [google-cloud-python/.generator](%20https://github.com/googleapis/google-cloud-python/tree/main/.generator) triggers the presubmit. It simply builds the Docker container.

## Do we need a hermetic build (no internet access)?

[Dan Gazineu](mailto:gazineu@google.com) says this is not in the requirements and is not needed, but may be done, especially if it leads to a cleaner design.

### Where to get proto dependencies other than googleapis

[Anthonios Partheniou](mailto:partheniou@google.com) suggests building these into the Docker image. What is the best design for this, both in the container and in `librariangen`?

A: The best design is probably sparse versions of the full repos, with exact repo name and paths for all protos.

## Do we need to provide an initial, hand-written state.yaml?

[Anthonios Partheniou](mailto:partheniou@google.com)is planning to do this.

## Do we support more than one Go version? If so, how?

Yes.

# Appendix A: Directory Listings

## `googleapis/googleapis-gen`

Current output structure for the `cloud.google.com/go/workflows` Go module, after `gapicgen` but before `postprocessor`. The OwlBot copy operation merges these separate output paths in `googleapis-gen`.

For brevity, `v1beta` paths are not shown.

```shell
googleapis-gen/google/cloud/workflows/v1/cloud.google.com/go$ tree .
.
├── internal
│   └── generated
│       └── snippets
│           └── workflows
│               └── apiv1
│                   ├── Client
│                   │   ├── CreateWorkflow
│                   │   │   └── main.go
│                   │   ├── DeleteOperation
│                   │   │   └── main.go
│                   │   ├── DeleteWorkflow
│                   │   │   └── main.go
│                   │   ├── GetLocation
│                   │   │   └── main.go
│                   │   ├── GetOperation
│                   │   │   └── main.go
│                   │   ├── GetWorkflow
│                   │   │   └── main.go
│                   │   ├── ListLocations
│                   │   │   └── main.go
│                   │   ├── ListOperations
│                   │   │   └── main.go
│                   │   ├── ListWorkflowRevisions
│                   │   │   └── main.go
│                   │   ├── ListWorkflows
│                   │   │   └── main.go
│                   │   └── UpdateWorkflow
│                   │       └── main.go
│                   └── snippet_metadata.google.cloud.workflows.v1.json
└── workflows
    └── apiv1
        ├── auxiliary.go
        ├── auxiliary_go123.go
        ├── doc.go
        ├── gapic_metadata.json
        ├── helpers.go
        ├── workflows_client_example_go123_test.go
        ├── workflows_client_example_test.go
        ├── workflows_client.go
        └── workflowspb
            └── workflows.pb.go
googleapis-gen/google/cloud/workflows/executions/v1/cloud.google.com/go$ tree .
.
├── internal
│   └── generated
│       └── snippets
│           └── workflows
│               └── executions
│                   └── apiv1
│                       ├── Client
│                       │   ├── CancelExecution
│                       │   │   └── main.go
│                       │   ├── CreateExecution
│                       │   │   └── main.go
│                       │   ├── GetExecution
│                       │   │   └── main.go
│                       │   └── ListExecutions
│                       │       └── main.go
│                       └── snippet_metadata.google.cloud.workflows.executions.v1.json
└── workflows
    └── executions
        └── apiv1
            ├── auxiliary.go
            ├── auxiliary_go123.go
            ├── doc.go
            ├── executions_client_example_go123_test.go
            ├── executions_client_example_test.go
            ├── executions_client.go
            ├── executionspb
            │   └── executions.pb.go
            ├── gapic_metadata.json
            └── helpers.go
```

## `googleapis/google-cloud-go`

Current output structure for the `cloud.google.com/go/workflows` Go module, final result after both `gapicgen` and `postprocessor`:

```shell
google-cloud-go/workflows$ tree .
.
├── aliasshim
│   └── aliasshim.go
├── apiv1
│   ├── auxiliary.go
│   ├── auxiliary_go123.go
│   ├── doc.go
│   ├── gapic_metadata.json
│   ├── helpers.go
│   ├── version.go
│   ├── workflows_client_example_go123_test.go
│   ├── workflows_client_example_test.go
│   ├── workflows_client.go
│   └── workflowspb
│       └── workflows.pb.go
├── CHANGES.md
├── executions
│   ├── apiv1
│   │   ├── auxiliary.go
│   │   ├── auxiliary_go123.go
│   │   ├── doc.go
│   │   ├── executions_client_example_go123_test.go
│   │   ├── executions_client_example_test.go
│   │   ├── executions_client.go
│   │   ├── executionspb
│   │   │   └── executions.pb.go
│   │   ├── gapic_metadata.json
│   │   ├── helpers.go
│   │   └── version.go
├── go.mod
├── go.sum
├── internal
│   └── version.go
└── README.md
google-cloud-go/internal/generated/snippets/workflows$ tree .
.
├── apiv1
│   ├── Client
│   │   ├── CreateWorkflow
│   │   │   └── main.go
│   │   ├── DeleteOperation
│   │   │   └── main.go
│   │   ├── DeleteWorkflow
│   │   │   └── main.go
│   │   ├── GetLocation
│   │   │   └── main.go
│   │   ├── GetOperation
│   │   │   └── main.go
│   │   ├── GetWorkflow
│   │   │   └── main.go
│   │   ├── ListLocations
│   │   │   └── main.go
│   │   ├── ListOperations
│   │   │   └── main.go
│   │   ├── ListWorkflowRevisions
│   │   │   └── main.go
│   │   ├── ListWorkflows
│   │   │   └── main.go
│   │   └── UpdateWorkflow
│   │       └── main.go
│   └── snippet_metadata.google.cloud.workflows.v1.json
└── executions
    ├── apiv1
    │   ├── Client
    │   │   ├── CancelExecution
    │   │   │   └── main.go
    │   │   ├── CreateExecution
    │   │   │   └── main.go
    │   │   ├── GetExecution
    │   │   │   └── main.go
    │   │   └── ListExecutions
    │   │       └── main.go
    │   └── snippet_metadata.google.cloud.workflows.executions.v1.json
```

[image1]: <data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABsAAAAbCAMAAAC6CgRnAAADAFBMVEX///+5Q+a5Q+a5Q+a5Q+a5Q+a5Q+a5Q+a5Q+a5Q+a5Q+a5Q+a5Q+a5Q+a5Q+a5Q+a5Q+bLcuzYlvHcofPpxffu0fnGZuvTiu/hrfT79P7///+9T+jlufb26PzPfu7CW+ny3Prn2uy+msydaLKVW6t8NZjfzeb38/mMTqWEQp7OtNmldLitgb/WwN+DN6KLOauaPL+pQNKuQNiePcSHOKd/Np2mP87Gp9KxQdy1QuG2jsWiPsnx5/Xv5vKTOrXt0Pjq0PTmz+/bwuXXtuO2Td7q2/HizurFnNW+kNCoa8CWO7qPOrG4WN3NqdoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACsRY1SAAAAEHRSTlMAEECAoMDQMFCwcJDg8GAggbhKsQAAANBJREFUeF6NkjkOAjEMRR2GYYkbGs7B/S9Dj9yEYmiQELG/s8wMAn6RxHnyEjuBqk7YUr0IcwA5djZDBRpbEJVSZR+QwU1vh7Gkh9ncIraHmykzR05UTlOJmRFzO5u2vmckdKapmlkBIaNHcoqozS+Od6KZL/JZ6U/LI8KlW2AXWymCstuIeQRjJJpo17GbLodBzKgvBbvq8xYk58M4WEtU0qHSFzGHnlCbA6+IMgSV2s2ipLUka5t25DX4/d5m+23uv/4LrShq+ON/qhw7yHoD2LYrfWJ+HeEAAAAASUVORK5CYII=>